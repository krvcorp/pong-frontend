{% extends "base.html" %}
{% load static %}
{% block page_content %}
<script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk="
    crossorigin="anonymous"></script>

<div class="layout__body mx-auto" style="width: 1200px">
    <div class="mx-auto" style="width: 600px">
        <!-- a div for a singular conversation with messages which are also in divs  -->
        <div class="conversation">
            <h2>Conversation</h2>
            <ul>
                {% for message in conversation.get_messages %}
                <li>
                    <a href="">{{ message.user }}</a>
                    <span>{{ message.message }}</span>
                </li>
                {% endfor %}
            </ul>
        </div>

        <!-- a full-width form to send a new message for the chat -->
        <div style="width: 600px" class="new-message">
            <h2>New Message</h2>
            <form action="" id="form">
                {% csrf_token %}
                <input type="text" id="message" name="message" placeholder="Message">
                <input type="submit" value="Send">
            </form>
        </div>

    </div>
</div>

<script type="text/javascript">
    // TODO: this is a bruteforce method of setting up WS server, should be replaced with a better method
    let url = "ws://localhost:8005/ws/socket-server/";
    const ws = new WebSocket(url);

    var token = '{{ csrf_token }}';

    ws.onmessage = function (event) {
        let data = JSON.parse(event.data);

        if (data.type === "chat") {
            $('.conversation ul').append(
                "<li><a href = \"\" >" + '{{ user.name }}' + "</a><span> " + data.message + "</span></li >"
            );
        }
    }

    let form = document.getElementById('form');
    form.addEventListener('submit', function (e) {
        e.preventDefault();
        let message = e.target.message.value
        let data = {
            message: message,
            conversation_id: "{{ conversation.id }}"
        };
        $.ajax({
            headers: { "X-CSRFToken": token },
            url: "{% url 'createmessage' conversation.id %}",
            type: "POST",
            data: data,
            success: function (data) {
                // alert('Message sent!');
            }
        });

        ws.send(JSON.stringify(data));
        form.reset();
    });

</script>

<!-- script from static/message.js -->
<script src="{% static '/js/message.js' %}" type="text/javascript"></script>

{% endblock %}