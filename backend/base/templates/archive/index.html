{% extends "base.html" %}
{% load static %}
{% block page_content %}
<link rel="stylesheet" href="{% static '/css/discover.css' %}">

<div class="body py-5 ">
    <div class="mx-auto" style="text-align:center">
        <h1 style="color:white">Pong</h1>
    </div>
    <div class="album py-5" style="width:50%; margin: 0 auto;">
        <div class="row">
            {% for post in posts %}
            <div class="col-md-7 mx-auto">
                <div class="card mb-4 box-shadow">
                    <div class="d-flex flex-column">
                        <div class="pl-2">
                            <small class="text-muted"> {{post.user.name}} - {{post.created_at}} </small>
                            <div class="post-vote mr-auto d-flex flex-column">
                                <form action="{% url 'postvote' %}" method="POST">
                                    {% csrf_token %}
                                    <button class="vote vote-post vote-post-upvote" type="submit">
                                        <i class="fa-solid fa-arrow-up"></i>
                                    </button>
                                </form>
                                <div class="mx-auto">
                                    <span class="post-votes-count{{ post.id }} text-bold">
                                        {{ post.total_score }}
                                    </span>
                                </div>
                                <form action="{% url 'postvote' %}" method="POST">
                                    {% csrf_token %}
                                    <button class="vote vote-post vote-post-downvote" type="submit">
                                        <i class="fa-solid fa-arrow-down"></i>
                                    </button>
                                </form>
                            </div>
                            <!-- <div class="">
                                <a href="{% url post post.id %}">
                                    <p>{{post.title}}</p>
                                </a>
                            </div> -->
                        </div>
                        {% if post.image %}
                        <div class="mx-auto mb-2">
                            <div class="card-img-top">
                                <img src="{{post.image.url}}" alt="{{post.title}}" class="card__image"
                                    style="width: 100%; max-width: 300px; max-height: 300px" />
                            </div>
                        </div>
                        {% endif %}
                    </div>



                    <div class="d-flex flex-row ml-2">
                        <!-- a div with a comment icon with the number of comments in the post -->
                        <div class="mr-1">
                            <!-- <a href="{% url 'post' %}">
                                <div class="num-comments">
                                    <i class="fa-regular fa-comment"></i>
                                    <small class="text-muted">
                                        {{post.num_comments}} comments
                                    </small>
                                </div>
                            </a> -->
                        </div>
                        <div class="mr-1">
                            <form action="{% url 'postreport' %}" method="POST">
                                {% csrf_token %}
                                <button class="report" type="submit">
                                    <i class="fa-regular fa-flag"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    {% if user.is_authenticated %}
    <div class="mx-auto new-post d-flex flex-column" style="width:20%">
        <!-- <form class="form" action="{% url 'post' %}" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <h1 style="color:white">New Post</h1>
            <div class="form__group">
                <textarea name="title" placeholder="Write a new post"></textarea>
                <p></p>
                <label for="image" class="custom-file-upload">
                    <i class="fa fa-cloud-upload"></i> Upload
                </label>
                <input name="image" id="image" type="file" />
                <button class="btn" type="submit">
                    <i class="fa-regular fa-plus"></i>
                    <span>Post</span>
                </button>
            </div>
        </form> -->
    </div>
    {% endif %}
</div>


<script>
    $(document).ready(function () {
        $('.vote-post').click(function (e) {
            e.preventDefault();
            var form = $(this).closest('form');
            var url = form.attr('action');
            var data = form.serialize();
            $.post(url, data, function (response) {
                // find the votes-count div and update with the new_score
                $('.post-votes-count' + response.post_id).text(response.new_score);
                // make the upvote button class "vote-upvoted"
                if (response.action = 'upvote') {
                    $('.vote-post-upvote').addClass('vote-upvoted');
                    $('.vote-post-downvote').removeClass('vote-downvoted');
                    $
                }
                $('.vote-post').removeClass('vote-upvoted');
            });
        });
    });
</script>

{% endblock %}